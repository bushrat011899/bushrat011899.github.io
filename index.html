<html>
    <head>
        <title>Hunt: Showstats</title>
        <style>
            body {
                margin: 0;
                padding: 0;
                width: 100%;
                height: 100%;
                font-family: Arial, Helvetica, sans-serif;
            }

            .styled-table {
                border-collapse: collapse;
                margin: 25px 0;
                font-size: 0.9em;
                font-family: sans-serif;
                min-width: 400px;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
                width: 100%;
                white-space: nowrap;
            }

            .styled-table thead tr {
                background-color: #009879;
                color: #ffffff;
                text-align: center;
            }

            .styled-table th,
            .styled-table td {
                padding: 12px 15px;
            }

            .styled-table tbody tr {
                border-bottom: 1px solid #dddddd;
            }

            .styled-table tbody tr:last-of-type {
                border-bottom: 2px solid #009879;
            }

            .styled-table tbody tr.myTeam {
                font-weight: bold;
                color: #009879;
                fill: #009879;
            }

            .styled-table tbody tr.myTeam th.me {
                font-weight: bold;
                color: #5b0098;
                fill: #5b0098;
            }

            .styled-table td:last-child {
                width: 100%;
            }
        </style>
        <script>
            const MMR_BRACKETS = [
                {lower: 0, upper: 2000, stars: 1},
                {lower: 2000, upper: 2300, stars: 2}, 
                {lower: 2300, upper: 2600, stars: 3},
                {lower: 2600, upper: 2750, stars: 4},
                {lower: 2750, upper: 3000, stars: 5},
                {lower: 3000, upper: 9000, stars: 6},
            ];

            const PERSON_SVG = `<svg width="1em" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M224 256c70.7 0 128-57.31 128-128s-57.3-128-128-128C153.3 0 96 57.31 96 128S153.3 256 224 256zM274.7 304H173.3C77.61 304 0 381.6 0 477.3c0 19.14 15.52 34.67 34.66 34.67h378.7C432.5 512 448 496.5 448 477.3C448 381.6 370.4 304 274.7 304z"/></svg>`;

            const PEOPLE_SVG = `<svg width="1em" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Pro 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M319.9 320c57.41 0 103.1-46.56 103.1-104c0-57.44-46.54-104-103.1-104c-57.41 0-103.1 46.56-103.1 104C215.9 273.4 262.5 320 319.9 320zM369.9 352H270.1C191.6 352 128 411.7 128 485.3C128 500.1 140.7 512 156.4 512h327.2C499.3 512 512 500.1 512 485.3C512 411.7 448.4 352 369.9 352zM512 160c44.18 0 80-35.82 80-80S556.2 0 512 0c-44.18 0-80 35.82-80 80S467.8 160 512 160zM183.9 216c0-5.449 .9824-10.63 1.609-15.91C174.6 194.1 162.6 192 149.9 192H88.08C39.44 192 0 233.8 0 285.3C0 295.6 7.887 304 17.62 304h199.5C196.7 280.2 183.9 249.7 183.9 216zM128 160c44.18 0 80-35.82 80-80S172.2 0 128 0C83.82 0 48 35.82 48 80S83.82 160 128 160zM551.9 192h-61.84c-12.8 0-24.88 3.037-35.86 8.24C454.8 205.5 455.8 210.6 455.8 216c0 33.71-12.78 64.21-33.16 88h199.7C632.1 304 640 295.6 640 285.3C640 233.8 600.6 192 551.9 192z"/></svg>`;
            
            const SKULL_SVG = `<svg width="1em" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Pro 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M416 400V464C416 490.5 394.5 512 368 512H320V464C320 455.2 312.8 448 304 448C295.2 448 288 455.2 288 464V512H224V464C224 455.2 216.8 448 208 448C199.2 448 192 455.2 192 464V512H144C117.5 512 96 490.5 96 464V400C96 399.6 96 399.3 96.01 398.9C37.48 357.8 0 294.7 0 224C0 100.3 114.6 0 256 0C397.4 0 512 100.3 512 224C512 294.7 474.5 357.8 415.1 398.9C415.1 399.3 416 399.6 416 400V400zM160 192C124.7 192 96 220.7 96 256C96 291.3 124.7 320 160 320C195.3 320 224 291.3 224 256C224 220.7 195.3 192 160 192zM352 320C387.3 320 416 291.3 416 256C416 220.7 387.3 192 352 192C316.7 192 288 220.7 288 256C288 291.3 316.7 320 352 320z"/></svg>`;

            const REGEX_UI_TIME = /([0-9]{1,2}):([0-9]{1,2})/g;
            const MATCH_TIME_MINUTES = 45;



            function dropHandler(ev) {
                // Prevent default behavior (Prevent file from being opened)
                ev.preventDefault();

                if (ev.dataTransfer.items) {
                    // Use DataTransferItemList interface to access the file(s)
                    for (let i = 0; i < ev.dataTransfer.items.length; i++) {
                        // If dropped items aren't files, reject them
                        if (ev.dataTransfer.items[i].kind === 'file') {
                            const file = ev.dataTransfer.items[i].getAsFile();
                            parseHuntAttrFile(file);
                        }
                    }
                } else {
                    // Use DataTransfer interface to access the file(s)
                    for (let i = 0; i < ev.dataTransfer.files.length; i++) {
                        parseHuntAttrFile(ev.dataTransfer.files[i]);
                    }
                }
            }

            function dragOverHandler(ev) {
                // Prevent default behavior (Prevent file from being opened)
                ev.preventDefault();
            }

            async function parseHuntAttrFile(file) {
                let text = await file.text();
                let xml = new window.DOMParser().parseFromString(text, "text/xml");

                function getTeamProperty(teamNumber = 0, property = undefined) {
                    const query = `Attr[name="MissionBagTeam_${teamNumber}${property ? '_'+property : ''}"]`;

                    let result = xml.querySelectorAll(query);

                    if (result.length > 0) {
                        return result[0].getAttribute('value');
                    }

                    return null;
                }

                function getPlayerProperty(teamNumber = 0, playerNumber = 0, property = "blood_line_name") {
                    const query = `Attr[name="MissionBagPlayer_${teamNumber}_${playerNumber}_${property}"]`;

                    let result = xml.querySelectorAll(query);

                    if (result.length > 0) {
                        return result[0].getAttribute('value');
                    }

                    return null;
                }

                let numberOfTeams = 12;

                let numberOfTeamsQuery = xml.querySelectorAll(`Attr[name="MissionBagNumTeams"]`);

                if (numberOfTeamsQuery.length > 0) {
                    numberOfTeams = parseInt(numberOfTeamsQuery[0].getAttribute('value'));
                }

                let teams = {};
                let players = {};
                for (let teamNumber = 0; teamNumber < numberOfTeams; teamNumber++) {
                    const teamExists = getTeamProperty(teamNumber) === "1";

                    if (teamExists) {
                        let team = {
                            isHandicapped: getTeamProperty(teamNumber, "handicap") === "1",
                            isRandom: getTeamProperty(teamNumber, "isinvite") === "false",
                            MMR: parseInt(getTeamProperty(teamNumber, "mmr")),
                            isMine: getTeamProperty(teamNumber, "ownteam") === "true",
                            size: parseInt(getTeamProperty(teamNumber, "numplayers")),
                            players: []
                        };

                        if (team.size > 0) {
                            for (let playerNumber = 0; playerNumber < team.size; playerNumber++) {
                                const playerName = getPlayerProperty(teamNumber, playerNumber, "blood_line_name");

                                /*  <Attr name="MissionBagPlayer_1_0_tooltip_downedbyteammate" value=""/>
                                    <Attr name="MissionBagPlayer_1_0_tooltipbountyextracted" value=""/>
                                    <Attr name="MissionBagPlayer_1_0_tooltipbountypickedup" value=""/>
                                    <Attr name="MissionBagPlayer_1_0_tooltipdownedbyme" value=""/>
                                    <Attr name="MissionBagPlayer_1_0_tooltipdownedme" value=""/>
                                    <Attr name="MissionBagPlayer_1_0_tooltipdownedteammate" value=""/>
                                    <Attr name="MissionBagPlayer_1_0_tooltipkilledbyme" value=""/>
                                    <Attr name="MissionBagPlayer_1_0_tooltipkilledbyteammate" value=""/>
                                    <Attr name="MissionBagPlayer_1_0_tooltipkilledme" value=""/>
                                    <Attr name="MissionBagPlayer_1_0_tooltipkilledteammate" value=""/>*/

                                if (playerName !== null) {
                                    let player = {
                                        name: playerName,
                                        team: teamNumber,
                                        bountiesExtracted: parseInt(getPlayerProperty(teamNumber, playerNumber, "bountyextracted")),
                                        bountiesPickedUp: parseInt(getPlayerProperty(teamNumber, playerNumber, "bountypickedup")),
                                        downsByMe: parseInt(getPlayerProperty(teamNumber, playerNumber, "downedbyme")),
                                        downsByTeamMate: parseInt(getPlayerProperty(teamNumber, playerNumber, "downedbyteammate")),
                                        downedMe: parseInt(getPlayerProperty(teamNumber, playerNumber, "downedme")),
                                        downedTeamMate: parseInt(getPlayerProperty(teamNumber, playerNumber, "downedteammate")),
                                        hadWellspring: getPlayerProperty(teamNumber, playerNumber, "hadWellspring") === "true",
                                        hadBounty: getPlayerProperty(teamNumber, playerNumber, "hadbounty") === "true",
                                        isPartner: getPlayerProperty(teamNumber, playerNumber, "ispartner") === "true",
                                        isSoulSurvivor: getPlayerProperty(teamNumber, playerNumber, "issoulsurvivor") === "true",
                                        killsByMe: parseInt(getPlayerProperty(teamNumber, playerNumber, "killedbyme")),
                                        killsByTeamMate: parseInt(getPlayerProperty(teamNumber, playerNumber, "killedbyteammate")),
                                        killedMe: parseInt(getPlayerProperty(teamNumber, playerNumber, "killedme")),
                                        killedTeamMate: parseInt(getPlayerProperty(teamNumber, playerNumber, "killedteammate")),
                                        MMR: parseInt(getPlayerProperty(teamNumber, playerNumber, "mmr")),
                                        ProfileID: parseInt(getPlayerProperty(teamNumber, playerNumber, "profileid")),
                                        wasProximity: getPlayerProperty(teamNumber, playerNumber, "proximity") === "true",
                                        wasProximityToMe: getPlayerProperty(teamNumber, playerNumber, "proximitytome") === "true",
                                        wasProximityToTeamMate: getPlayerProperty(teamNumber, playerNumber, "proximitytoteammate") === "true",
                                        wasSkillBased: getPlayerProperty(teamNumber, playerNumber, "skillbased") === "true",
                                        wasTeamExtraction: getPlayerProperty(teamNumber, playerNumber, "teamextraction") === "true",
                                    };

                                    if (typeof players[playerName] === "undefined") {
                                        players[playerName] = player;
                                        team.players.push(playerName);
                                    }
                                }
                            }
                            
                            teams[teamNumber] = team;
                        }
                    }
                }

                updateTable(teams, players);
            }

            function updateTable(teams, players) {
                const tbody = document.getElementById('tbody');
                tbody.innerHTML = "";

                for (const teamNumber in teams) {
                    const team = teams[teamNumber];
                    const teamNumberCell = `<th rowspan="${team.size}">${teamNumber}</th>`;

                    const teamStars = MMR_BRACKETS
                        .find(bracket => bracket.lower <= team.MMR && bracket.upper > team.MMR)
                        .stars;
                    const teamMMRCell = `<td style="width: 13em;" rowspan="${team.size}">${team.MMR} [${'★'.repeat(teamStars)}${'☆'.repeat(6-teamStars)}]</td>`;
                    let addedTeamInfo = false;

                    for (const playerName of team.players) {
                        const player = players[playerName];

                        const isMe = !player.isPartner && team.isMine;

                        const playerNameCell = `<th class="${isMe ? 'me' : ''}">${isMe ? PERSON_SVG : player.isPartner ? PEOPLE_SVG : ''}${playerName}</th>`;

                        const stars = MMR_BRACKETS
                            .find(bracket => bracket.lower <= player.MMR && bracket.upper > player.MMR)
                            .stars;

                        const playerMMRCell = `<td class="${isMe ? 'me' : ''}" style="width: 13em;">${player.MMR} [${'★'.repeat(stars)}${'☆'.repeat(6-stars)}]</td>`;

                        const KDAData = [
                            player.killsByMe + player.downsByMe,
                            player.killedMe + player.downedMe,
                            player.killsByTeamMate + player.downsByTeamMate,
                            player.killedTeamMate + player.downedTeamMate,
                        ];

                        const KDACells = KDAData
                            .map(stat => `<td style="width: 12em; text-align: center;" class="${isMe ? 'me' : ''}">${stat === 0 ? '' : stat}</td>`)
                            .join('');
                        
                        const playerTimelineCell = `<td></td>`;

                        let cells = playerNameCell + playerMMRCell + KDACells + playerTimelineCell;
                        if (!addedTeamInfo) {
                            cells = teamNumberCell + teamMMRCell + cells;
                            addedTeamInfo = true;
                        }

                        tbody.innerHTML += `<tr class="${team.isMine ? 'myTeam' : ''}">${cells}</tr>`;
                    }
                }
            }
        </script>
    </head>
    <body ondrop="dropHandler(event);" ondragover="dragOverHandler(event);">
        <h1>Hunt: Showstats</h1>
        <p>Drag your <a href="file://C:/Program%20Files%20(x86)/Steam/steamapps/common/Hunt%20Showdown/user/profiles/default">attributes.xml</a> file anywhere into the browser window to update the below table with information from your last game.</p>
        <table class="styled-table">
            <thead>
                <tr>
                    <th>Team</th>
                    <th>Team MMR</th>
                    <th>Name</th>
                    <th>MMR</th>
                    <th>My Kills</th>
                    <th>My Deaths</th>
                    <th>Team Kills</th>
                    <th>Team Deaths</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
    </body>
</html>